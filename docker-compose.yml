version: '3.7'
services:
  redis:
    image: redis:5.0
    ports:
      - 6100:6379
  jwt:
    image: registry.gitlab.com/techlock/mock-jwt-service:master_db19813762b2309bc71cb3f539b51acefbc7c74a
    environment:
      FLASK_JWT_IDENTITY_CLAIM: sub
      FLASK_JWT_USER_CLAIMS: claims
    ports:
      - 6101:5000
  dynamodb:
    image: amazon/dynamodb-local:latest
    ports:
      - 6102:8000
  cognito:
    image: motoserver/moto:1.3.5
    ports:
      - 6103:5000
    command: -p 5000 cognito-idp
  psql:
    image: postgres:11
    ports:
      - 6104:5432
    environment:
      POSTGRES_USER: techlock
      POSTGRES_PASSWORD: password

  init:
    # image: registry.gitlab.com/techlock/msc-user-management-service:master_latest
    build:
      context: .
      args:
        NEXUS_HOST: ${NEXUS_HOST}
        NEXUS_USERNAME: ${NEXUS_USERNAME}
        NEXUS_PASSWORD: ${NEXUS_PASSWORD}
      cache_from:
        - registry.gitlab.com/techlock/msc-user-management-service:${CI_COMMIT_REF_SLUG:-master}_latest
    depends_on:
      - redis
      - dynamodb
      - cognito
      - jwt
      - psql
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_SOCKET_CONNECT_TIMEOUT: 30
      REDIS_IS_CLUSTER: 'false'
      REDIS_SKIP_FULL_COVERAGE_CHECK: 'false'
      DYNAMODB_ENDPOINT_URL: http://dynamodb:8000
      COGNITO_IDP_ENDPOINT_URL: http://cognito:5000
      AWS_ACCESS_KEY_ID: fake
      AWS_SECRET_ACCESS_KEY: fake
      AWS_DEFAULT_REGION: us-east-1
      STAGE: test
      # LOG_LEVEL: debug
      TENANT_ID: test
      NO_CACHE: ${NO_CACHE:-true}
      FLASK_APP: techlock/user_management_service/app.py
      FLASK_SQLALCHEMY_DATABASE_URI: postgresql://techlock:password@psql:5432/postgres
      FLASK_JWT_ALGORITHM: RS256
      JWKS_URLS: 'http://jwt:5000/.well-known/jwks.json'
    ports:
      - 5000
    entrypoint:
      - "/usr/bin/wait-for-it"
      - "cognito:5000"
      - "-s"
      - "--timeout=30"
      - "--"
      - '/app/run_tests.sh'
      - '--init'

  api:
    # image: registry.gitlab.com/techlock/msc-user-management-service:master_latest
    build:
      context: .
      args:
        NEXUS_HOST: ${NEXUS_HOST}
        NEXUS_USERNAME: ${NEXUS_USERNAME}
        NEXUS_PASSWORD: ${NEXUS_PASSWORD}
      cache_from:
        - registry.gitlab.com/techlock/msc-user-management-service:${CI_COMMIT_REF_SLUG:-master}_latest
    depends_on:
      - redis
      - dynamodb
      - cognito
      - jwt
      - psql
      - init
    entrypoint:
      - flask
      - run
      - --host=0.0.0.0
    volumes:
      - './techlock/user_management_service/:/app/techlock/user_management_service/'
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_SOCKET_CONNECT_TIMEOUT: 30
      REDIS_IS_CLUSTER: 'false'
      REDIS_SKIP_FULL_COVERAGE_CHECK: 'false'
      DYNAMODB_ENDPOINT_URL: http://dynamodb:8000
      UI_CONFIG_ENSILO_URL: https://techlockinc.console.ensilo.com
      UI_CONFIG_KIBANA_URL: http://techlock.kibana.com
      COGNITO_IDP_ENDPOINT_URL: http://cognito:5000
      AWS_ACCESS_KEY_ID: fake
      AWS_SECRET_ACCESS_KEY: fake
      AWS_DEFAULT_REGION: us-east-1
      STAGE: test
      # LOG_LEVEL: debug
      TENANT_ID: test
      NO_CACHE: ${NO_CACHE:-true}
      FLASK_APP: techlock/user_management_service/app.py
      FLASK_ENV: development
      FLASK_DEBUG: 1
      FLASK_SQLALCHEMY_DATABASE_URI: postgresql://techlock:password@psql:5432/postgres
      FLASK_JWT_ALGORITHM: RS256
      JWKS_URLS: 'http://jwt:5000/.well-known/jwks.json'
    ports:
      - 6105:5000
