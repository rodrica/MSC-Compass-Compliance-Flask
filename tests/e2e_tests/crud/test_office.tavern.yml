---
test_name: Office API CRUD Happy
marks:
  - usefixtures:
      - flush_local_dynamodb
stages:
  - name: Get JWT
    request:
      url: http://jwt:5000/login
      method: POST
      headers:
        content-type: application/json
      json:
        sub: test@test.com
        tenant_id: tenant1
        roles:
          - tenant1
          - tenant1:admin
        claims:
          - allow:tenant1:user-management:*:offices:*
    response:
      status_code: 200
      save:
        body:
          access_token: access_token

  - name: Get all Offices
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        total_items: 0

  - name: Create Office
    request:
      url: http://app:5000/offices
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: New York
        street1: Stark Avenue
        city: New York
        state: New York
        postal_code: "10048"
        country: United States
    response:
      status_code: 201
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              name: New York
              description: null
              street1: Stark Avenue
              street2: null
              street3: null
              city: New York
              state: New York
              country: United States
              postal_code: "10048"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant1
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
      save:
        body:
          created_id: entity_id

  - name: Get Office
    request:
      url: http://app:5000/offices/{created_id}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              entity_id: "{created_id}"
              name: New York
              description: null
              street1: Stark Avenue
              street2: null
              street3: null
              city: New York
              state: New York
              country: United States
              postal_code: "10048"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant1
              created_by: test@test.com
              changed_by: test@test.com
              tags: null

  - name: Update Office
    request:
      url: http://app:5000/offices/{created_id}
      method: PUT
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: Stark Tower
        street1: Stark Avenue
        city: New York
        state: New York
        postal_code: "10048"
        country: United States
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              entity_id: "{created_id}"
              name: Stark Tower
              description: null
              street1: Stark Avenue
              street2: null
              street3: null
              city: New York
              state: New York
              country: United States
              postal_code: "10048"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant1
              created_by: test@test.com
              changed_by: test@test.com
              tags: null

  - name: Delete Office
    request:
      url: http://app:5000/offices/{created_id}
      method: DELETE
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 204

  - name: Get all Offices - confirm deletion
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        total_items: 0

---
test_name: Offices API GET Happy
marks:
  - usefixtures:
      - flush_local_dynamodb
stages:
  - name: Get JWT
    request:
      url: http://jwt:5000/login
      method: POST
      headers:
        content-type: application/json
      json:
        sub: test@test.com
        tenant_id: tenant1
        roles:
          - tenant1
          - tenant1:admin
        claims:
          - allow:tenant1:user-management:*:offices:*
    response:
      status_code: 200
      save:
        body:
          access_token: access_token

  - name: Get JWT2
    request:
      url: http://jwt:5000/login
      method: POST
      headers:
        content-type: application/json
      json:
        sub: test2@test.com
        tenant_id: tenant2
        roles:
          - tenant2
          - tenant2:admin
        claims:
          - allow:tenant2:user-management:*:offices:*
    response:
      status_code: 200
      save:
        body:
          access_token2: access_token

  - name: Get all Offices - tenant1
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        total_items: 0

  - name: Get all Offices - tenant2
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        total_items: 0

  - name: Create Office1 - tenant1
    request:
      url: http://app:5000/offices
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: New York
        street1: Stark Avenue
        city: New York
        state: New York
        postal_code: "10048"
        country: United States
    response:
      status_code: 201
      save:
        body:
          office1: entity_id

  - name: Create Office2 - tenant1
    request:
      url: http://app:5000/offices
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: Washington
        street1: Stark Avenue
        city: Washington
        state: Washington
        postal_code: "20058"
        country: United States
    response:
      status_code: 201
      save:
        body:
          office2: entity_id

  - name: Create Office3 - tenant2
    request:
      url: http://app:5000/offices
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token2}"
      json:
        name: Hulk Compound
        street1: Banner Avenue
        city: San Fransisco
        state: California
        postal_code: "20058"
        country: United States
    response:
      status_code: 201
      save:
        body:
          office3: entity_id

  - name: Get all Offices - tenant1 - no filters
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              items:
                - entity_id: "{office1}"
                  name: New York
                  description: null
                  street1: Stark Avenue
                  street2: null
                  street3: null
                  city: New York
                  state: New York
                  country: United States
                  postal_code: "10048"
                  latitude: null
                  longitude: null
                  departments: []
                  tenant_id: tenant1
                  created_by: test@test.com
                  changed_by: test@test.com
                  tags: null
                - entity_id: "{office2}"
                  name: Washington
                  description: null
                  street1: Stark Avenue
                  street2: null
                  street3: null
                  city: Washington
                  state: Washington
                  country: United States
                  postal_code: "20058"
                  latitude: null
                  longitude: null
                  departments: []
                  tenant_id: tenant1
                  created_by: test@test.com
                  changed_by: test@test.com
                  tags: null
              num_items: 2
              total_items: 2

  - name: Get all Offices - tenant2 - no filters
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token2}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              items:
                - entity_id: "{office3}"
                  name: Hulk Compound
                  description: null
                  street1: Banner Avenue
                  street2: null
                  street3: null
                  city: San Fransisco
                  state: California
                  country: United States
                  postal_code: "20058"
                  latitude: null
                  longitude: null
                  departments: []
                  tenant_id: tenant2
                  created_by: test2@test.com
                  changed_by: test2@test.com
                  tags: null
              num_items: 1
              total_items: 1

  - name: Get all Offices - tenant1 - filter by name case insensitive endswith wildcard
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      params:
        name: new*
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              items:
                - entity_id: "{office1}"
                  name: New York
                  description: null
                  street1: Stark Avenue
                  street2: null
                  street3: null
                  city: New York
                  state: New York
                  country: United States
                  postal_code: "10048"
                  latitude: null
                  longitude: null
                  departments: []
                  tenant_id: tenant1
                  created_by: test@test.com
                  changed_by: test@test.com
                  tags: null
              num_items: 1
              total_items: 1

  - name: Get all Offices - tenant1 - filter by created_by order by name desc
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      params:
        created_by: test@test.com
        sort: name:desc
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              items:
                - entity_id: "{office2}"
                  name: Washington
                  description: null
                  street1: Stark Avenue
                  street2: null
                  street3: null
                  city: Washington
                  state: Washington
                  country: United States
                  postal_code: "20058"
                  latitude: null
                  longitude: null
                  departments: []
                  tenant_id: tenant1
                  created_by: test@test.com
                  changed_by: test@test.com
                  tags: null
                - entity_id: "{office1}"
                  name: New York
                  description: null
                  street1: Stark Avenue
                  street2: null
                  street3: null
                  city: New York
                  state: New York
                  country: United States
                  postal_code: "10048"
                  latitude: null
                  longitude: null
                  departments: []
                  tenant_id: tenant1
                  created_by: test@test.com
                  changed_by: test@test.com
                  tags: null
              num_items: 2
              total_items: 2

  - name: Get Office1 - tenant1
    request:
      url: http://app:5000/offices/{office1}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              entity_id: "{office1}"
              name: New York
              description: null
              street1: Stark Avenue
              street2: null
              street3: null
              city: New York
              state: New York
              country: United States
              postal_code: "10048"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant1
              created_by: test@test.com
              changed_by: test@test.com
              tags: null

  - name: Get Office3 - tenant1
    request:
      url: http://app:5000/offices/{office3}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 404

  - name: Get Office1 - tenant2
    request:
      url: http://app:5000/offices/{office1}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token2}"
    response:
      status_code: 404

  - name: Get Office3 - tenant2
    request:
      url: http://app:5000/offices/{office3}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token2}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              entity_id: "{office3}"
              name: Hulk Compound
              description: null
              street1: Banner Avenue
              street2: null
              street3: null
              city: San Fransisco
              state: California
              country: United States
              postal_code: "20058"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant2
              created_by: test2@test.com
              changed_by: test2@test.com
              tags: null

---
test_name: Offices API create and update validation
marks:
  - usefixtures:
      - flush_local_dynamodb
stages:
  - name: Get JWT
    request:
      url: http://jwt:5000/login
      method: POST
      headers:
        content-type: application/json
      json:
        sub: test@test.com
        tenant_id: tenant1
        roles:
          - tenant1
          - tenant1:admin
        claims:
          - allow:tenant1:user-management:*:offices:*
    response:
      status_code: 200
      save:
        body:
          access_token: access_token

  - name: Get all Offices
    request:
      url: http://app:5000/offices
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        total_items: 0

  - name: Create Office
    request:
      url: http://app:5000/offices
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: New York
        street1: Stark Avenue
        city: New York
        state: New York
        postal_code: "10048"
        country: United States
    response:
      status_code: 201
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              name: New York
              description: null
              street1: Stark Avenue
              street2: null
              street3: null
              city: New York
              state: New York
              country: United States
              postal_code: "10048"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant1
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
      save:
        body:
          office_id: entity_id

  - name: Create Office - with empty body
    request:
      url: http://app:5000/offices
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json: {}
    response:
      status_code: 422
      body:
        code: 422
        errors:
          name:
            - Missing data for required field.
        status: Unprocessable Entity

  # TODO - update validation
  - name: Update Office
    request:
      url: http://app:5000/offices/{office_id}
      method: PUT
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: Start Tower
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_base_model
          extra_kwargs:
            expected:
              entity_id: "{office_id}"
              name: Start Tower
              description: null
              street1: Stark Avenue
              street2: null
              street3: null
              city: New York
              state: New York
              country: United States
              postal_code: "10048"
              latitude: null
              longitude: null
              departments: []
              tenant_id: tenant1
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
