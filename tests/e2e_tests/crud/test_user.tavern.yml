---
test_name: Users API Happy
marks:
  - usefixtures:
      - flush_local_dynamodb
stages:
  - name: Get JWT
    request:
      url: http://jwt:5000/login
      method: POST
      headers:
        content-type: application/json
      json:
        sub: test@test.com
        tenant_id: tenant1
        roles:
          - tenant1
          - tenant1:admin
        claims:
          - allow:tenant1:user-management:*:users:*
          - deny:tenant1:user-management:*:users:denied_user
    response:
      status_code: 200
      save:
        body:
          access_token: access_token

  - name: Get all Users
    request:
      url: http://app:5000/users
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        cursor: null
        page_cursors: null
        total_items: 0

  - name: Create User
    request:
      url: http://app:5000/users
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: Test
        family_name: e2e
        email: test2@test.com
        temporary_password: changeme
    response:
      status_code: 201
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_persisted_object
          extra_kwargs:
            expected:
              name: Test
              family_name: e2e
              email: test2@test.com
              department_ids: null
              office_ids: null
              role_ids: null
              claims_by_audience: null
              tenant_id: tenant1
              is_latest: true
              is_active: true
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
      save:
        body:
          created_id: entity_id
          created_version: version

  - name: Get User
    request:
      url: http://app:5000/users/{created_id}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_persisted_object
          extra_kwargs:
            expected:
              entity_id: "{created_id}"
              name: Test
              family_name: e2e
              email: test2@test.com
              department_ids: null
              office_ids: null
              role_ids: null
              claims_by_audience: null
              tenant_id: tenant1
              is_latest: true
              is_active: true
              created_by: test@test.com
              changed_by: test@test.com
              tags: null

  - name: Update User
    request:
      url: http://app:5000/users/{created_id}
      method: PUT
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: Test
        family_name: e2e_new
        email: test2@test.com
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_persisted_object
          extra_kwargs:
            expected:
              entity_id: "{created_id}"
              name: Test
              family_name: e2e_new
              email: test2@test.com
              department_ids: null
              office_ids: null
              role_ids: null
              claims_by_audience: null
              tenant_id: tenant1
              is_latest: true
              is_active: true
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
              previous_version: "{created_version}"
      save:
        body:
          updated_version: version

  - name: Delete User
    request:
      url: http://app:5000/users/{created_id}
      method: DELETE
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 204

  - name: Get all Users - confirm deletion
    request:
      url: http://app:5000/users
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        num_items: 0
        cursor: null
        page_cursors: null
        total_items: 0
