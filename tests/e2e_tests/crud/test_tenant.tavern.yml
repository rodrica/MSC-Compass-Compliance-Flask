---
test_name: Tenants API Happy
marks:
  - usefixtures:
      - flush_local_dynamodb
stages:
  - name: Get JWT
    request:
      url: http://jwt:5000/login
      method: POST
      headers:
        content-type: application/json
      json:
        sub: test@test.com
        tenant_id: tenant1
        roles:
          - tenant1
          - tenant1:admin
        claims:
          - allow:*:user-management:*:tenants:*
          - deny:*:user-management:*:tenants:denied_user
    response:
      status_code: 200
      save:
        body:
          access_token: access_token

  - name: Get all Tenants
    request:
      url: http://app:5000/tenants
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        items: []
        last_key: null
        num_items: 0

  - name: Create Tenant
    request:
      url: http://app:5000/tenants
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
      json:
        name: Test Tenant
        description: Simple description
    response:
      status_code: 201
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_persisted_object
          extra_kwargs:
            expected:
              name: Test Tenant
              description: Simple description
              tenant_id: tenant1
              is_latest: true
              is_active: true
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
      save:
        body:
          created_id: entity_id
          created_version: version

  - name: Get Tenant
    request:
      url: http://app:5000/tenants/{created_id}
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token}"
    response:
      status_code: 200
      body:
        $ext:
          function: techlock.common.unittest.tavern_validators:validate_persisted_object
          extra_kwargs:
            expected:
              entity_id: "{created_id}"
              name: Test Tenant
              description: Simple description
              tenant_id: tenant1
              is_latest: true
              is_active: true
              created_by: test@test.com
              changed_by: test@test.com
              tags: null
